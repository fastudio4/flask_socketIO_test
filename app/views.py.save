from . import app, sio
from flask import render_template
from flask_socketio import emit
from time import strftime
from pyA20.gpio import gpio
from pyA20.gpio import port
import dht11

PIN2 = port.PA6
gpio.init()

instance = dht11.DHT11(pin=PIN2)

thread = None


def background_thread():
    while True:
	sio.sleep(1)
	result = instance.read()
	if result.is_valid():
        	        	count = result.temperature
        	sio.emit('my_response', {'data': 'Message from server', 'count': count}, namespace='/test')

@app.route('/')
def home():
    return render_template('index.html', title='My page')


@sio.on('connect', namespace='/test')
def test_connect():
    global thread
    if thread is None:
        thread = sio.start_background_task(target=background_thread)
    emit('my_response', {'data': 'Connected', 'count': 0})
